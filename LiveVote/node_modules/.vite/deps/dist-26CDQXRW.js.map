{
  "version": 3,
  "sources": ["../../@safe-global/safe-apps-provider/src/utils.ts", "../../@safe-global/safe-apps-provider/src/provider.ts", "../../@safe-global/safe-apps-provider/src/index.ts"],
  "sourcesContent": ["export function getLowerCase(value: string): string {\r\n  if (value) {\r\n    return value.toLowerCase();\r\n  }\r\n  return value;\r\n}\r\n", "import SafeAppsSDK, { SafeInfo, Web3TransactionObject } from '@safe-global/safe-apps-sdk';\r\nimport { EventEmitter } from 'events';\r\nimport { EIP1193Provider } from './types';\r\nimport { getLowerCase } from './utils';\r\n\r\n// The API is based on Ethereum JavaScript API Provider Standard. Link: https://eips.ethereum.org/EIPS/eip-1193\r\nexport class SafeAppProvider extends EventEmitter implements EIP1193Provider {\r\n  private readonly safe: SafeInfo;\r\n  private readonly sdk: SafeAppsSDK;\r\n  private submittedTxs = new Map<string, Web3TransactionObject>();\r\n\r\n  constructor(safe: SafeInfo, sdk: SafeAppsSDK) {\r\n    super();\r\n    this.safe = safe;\r\n    this.sdk = sdk;\r\n  }\r\n\r\n  async connect(): Promise<void> {\r\n    this.emit('connect', { chainId: this.chainId });\r\n    return;\r\n  }\r\n\r\n  async disconnect(): Promise<void> {\r\n    return;\r\n  }\r\n\r\n  public get chainId(): number {\r\n    return this.safe.chainId;\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  async request(request: { method: string; params?: any[] }): Promise<any> {\r\n    const { method, params = [] } = request;\r\n\r\n    switch (method) {\r\n      case 'eth_accounts':\r\n        return [this.safe.safeAddress];\r\n\r\n      case 'net_version':\r\n      case 'eth_chainId':\r\n        return `0x${this.chainId.toString(16)}`;\r\n\r\n      case 'personal_sign': {\r\n        const [message, address] = params;\r\n\r\n        if (this.safe.safeAddress.toLowerCase() !== address.toLowerCase()) {\r\n          throw new Error('The address or message hash is invalid');\r\n        }\r\n\r\n        const response = await this.sdk.txs.signMessage(message);\r\n        const signature = 'signature' in response ? response.signature : undefined;\r\n\r\n        return signature || '0x';\r\n      }\r\n\r\n      case 'eth_sign': {\r\n        const [address, messageHash] = params;\r\n\r\n        if (this.safe.safeAddress.toLowerCase() !== address.toLowerCase() || !messageHash.startsWith('0x')) {\r\n          throw new Error('The address or message hash is invalid');\r\n        }\r\n\r\n        const response = await this.sdk.txs.signMessage(messageHash);\r\n        const signature = 'signature' in response ? response.signature : undefined;\r\n\r\n        return signature || '0x';\r\n      }\r\n\r\n      case 'eth_signTypedData':\r\n      case 'eth_signTypedData_v4': {\r\n        const [address, typedData] = params;\r\n        const parsedTypedData = typeof typedData === 'string' ? JSON.parse(typedData) : typedData;\r\n\r\n        if (this.safe.safeAddress.toLowerCase() !== address.toLowerCase()) {\r\n          throw new Error('The address is invalid');\r\n        }\r\n\r\n        const response = await this.sdk.txs.signTypedMessage(parsedTypedData);\r\n        const signature = 'signature' in response ? response.signature : undefined;\r\n        return signature || '0x';\r\n      }\r\n\r\n      case 'eth_sendTransaction':\r\n        // `value` or `data` can be explicitly set as `undefined` for example in Viem. The spread will overwrite the fallback value.\r\n        const tx = {\r\n          ...params[0],\r\n          value: params[0].value || '0',\r\n          data: params[0].data || '0x',\r\n        };\r\n\r\n        // Some ethereum libraries might pass the gas as a hex-encoded string\r\n        // We need to convert it to a number because the SDK expects a number and our backend only supports\r\n        // Decimal numbers\r\n        if (typeof tx.gas === 'string' && tx.gas.startsWith('0x')) {\r\n          tx.gas = parseInt(tx.gas, 16);\r\n        }\r\n\r\n        const resp = await this.sdk.txs.send({\r\n          txs: [tx],\r\n          params: { safeTxGas: tx.gas },\r\n        });\r\n\r\n        // Store fake transaction\r\n        this.submittedTxs.set(resp.safeTxHash, {\r\n          from: this.safe.safeAddress,\r\n          hash: resp.safeTxHash,\r\n          gas: 0,\r\n          gasPrice: '0x00',\r\n          nonce: 0,\r\n          input: tx.data,\r\n          value: tx.value,\r\n          to: tx.to,\r\n          blockHash: null,\r\n          blockNumber: null,\r\n          transactionIndex: null,\r\n        });\r\n        return resp.safeTxHash;\r\n\r\n      case 'eth_blockNumber':\r\n        const block = await this.sdk.eth.getBlockByNumber(['latest']);\r\n\r\n        return block.number;\r\n\r\n      case 'eth_getBalance':\r\n        return this.sdk.eth.getBalance([getLowerCase(params[0]), params[1]]);\r\n\r\n      case 'eth_getCode':\r\n        return this.sdk.eth.getCode([getLowerCase(params[0]), params[1]]);\r\n\r\n      case 'eth_getTransactionCount':\r\n        return this.sdk.eth.getTransactionCount([getLowerCase(params[0]), params[1]]);\r\n\r\n      case 'eth_getStorageAt':\r\n        return this.sdk.eth.getStorageAt([getLowerCase(params[0]), params[1], params[2]]);\r\n\r\n      case 'eth_getBlockByNumber':\r\n        return this.sdk.eth.getBlockByNumber([params[0], params[1]]);\r\n\r\n      case 'eth_getBlockByHash':\r\n        return this.sdk.eth.getBlockByHash([params[0], params[1]]);\r\n\r\n      case 'eth_getTransactionByHash':\r\n        let txHash = params[0];\r\n        try {\r\n          const resp = await this.sdk.txs.getBySafeTxHash(txHash);\r\n          txHash = resp.txHash || txHash;\r\n        } catch (e) {}\r\n        // Use fake transaction if we don't have a real tx hash\r\n        if (this.submittedTxs.has(txHash)) {\r\n          return this.submittedTxs.get(txHash);\r\n        }\r\n        return this.sdk.eth.getTransactionByHash([txHash]).then((tx) => {\r\n          // We set the tx hash to the one requested, as some provider assert this\r\n          if (tx) {\r\n            tx.hash = params[0];\r\n          }\r\n          return tx;\r\n        });\r\n\r\n      case 'eth_getTransactionReceipt': {\r\n        let txHash = params[0];\r\n        try {\r\n          const resp = await this.sdk.txs.getBySafeTxHash(txHash);\r\n          txHash = resp.txHash || txHash;\r\n        } catch (e) {}\r\n        return this.sdk.eth.getTransactionReceipt([txHash]).then((tx) => {\r\n          // We set the tx hash to the one requested, as some provider assert this\r\n          if (tx) {\r\n            tx.transactionHash = params[0];\r\n          }\r\n          return tx;\r\n        });\r\n      }\r\n\r\n      case 'eth_estimateGas': {\r\n        return this.sdk.eth.getEstimateGas(params[0]);\r\n      }\r\n\r\n      case 'eth_call': {\r\n        return this.sdk.eth.call([params[0], params[1]]);\r\n      }\r\n\r\n      case 'eth_getLogs':\r\n        return this.sdk.eth.getPastLogs([params[0]]);\r\n\r\n      case 'eth_gasPrice':\r\n        return this.sdk.eth.getGasPrice();\r\n\r\n      case 'wallet_getPermissions':\r\n        return this.sdk.wallet.getPermissions();\r\n\r\n      case 'wallet_requestPermissions':\r\n        return this.sdk.wallet.requestPermissions(params[0]);\r\n\r\n      case 'safe_setSettings':\r\n        return this.sdk.eth.setSafeSettings([params[0]]);\r\n\r\n      default:\r\n        throw Error(`\"${request.method}\" not implemented`);\r\n    }\r\n  }\r\n\r\n  // this method is needed for ethers v4\r\n  // https://github.com/ethers-io/ethers.js/blob/427e16826eb15d52d25c4f01027f8db22b74b76c/src.ts/providers/web3-provider.ts#L41-L55\r\n  send(request: any, callback: (error: any, response?: any) => void): void {\r\n    if (!request) callback('Undefined request');\r\n    this.request(request)\r\n      .then((result) => callback(null, { jsonrpc: '2.0', id: request.id, result }))\r\n      .catch((error) => callback(error, null));\r\n  }\r\n}\r\n", "export { SafeAppProvider } from './provider';\r\n"],
  "mappings": "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",
  "names": ["resp", "tx", "txHash"]
}
